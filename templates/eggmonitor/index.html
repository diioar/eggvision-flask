{% extends "base.html" %}
{% block title %}Dashboard Â· EggVision{% endblock %}

{% block body %}
<div class="min-h-screen bg-background">
  <!-- Sidebar -->
  <aside class="fixed left-0 top-0 h-screen w-[130px] bg-sidebar border-r border-sidebar-border flex flex-col">
    <!-- Logo -->
    <div class="p-6 border-b border-sidebar-border">
      <div class="flex flex-col items-center gap-2">
        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
          <div class="text-primary font-bold text-xs">EV</div>
        </div>
        <span class="text-primary text-sm font-semibold">EGGVISION</span>
      </div>
    </div>

    <!-- Menu -->
    <nav class="flex-1 py-4">
      {% set menu = [
        {"id":"dashboard","icon":"layout-dashboard","label":"Dashboard","href":"/"},
        {"id":"laporan","icon":"database","label":"Laporan","href":"/laporan"},
        {"id":"detail","icon":"grid-3x3","label":"Detail Alat","href":"#"},
        {"id":"eggmart","icon":"shopping-cart","label":"EggMart","href":"#"},
        {"id":"settings","icon":"settings","label":"Pengaturan","href":"/settings"}
      ] %}
      {% for item in menu %}
        {% set is_active = (item.id == active_menu) %}
        <a href="{{ item.href }}"
           class="w-full px-4 py-4 flex flex-col items-center gap-2 transition-colors
           {{ 'text-sidebar-accent-foreground bg-sidebar-accent' if is_active else 'text-sidebar-foreground hover:text-sidebar-accent-foreground hover:bg-sidebar-accent/50' }}">
          <i data-lucide="{{ item.icon }}" class="w-6 h-6"></i>
          <span class="text-xs">{{ item.label }}</span>
        </a>
      {% endfor %}
    </nav>

    <!-- Profile -->
    <div class="p-4 border-t border-sidebar-border">
      <a href="/profile" class="w-full flex flex-col items-center gap-2 text-sidebar-foreground hover:text-sidebar-accent-foreground">
        <div class="w-10 h-10 rounded-full bg-muted overflow-hidden">
          <img
            src="https://api.dicebear.com/7.x/avataaars/svg?seed=user"
            alt="Profile"
            class="w-full h-full object-cover" />
        </div>
        <span class="text-xs">Profil</span>
    </a>
    </div>
  </aside>

  <!-- Main -->
  <main class="ml-[130px] p-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-4xl font-bold mb-1">Dashboard</h1>
        <p class="text-muted-foreground">Overview Produksi</p>
      </div>

      <div class="flex items-center gap-8">
        <!-- User Info -->
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-muted overflow-hidden">
            <img
              src="https://api.dicebear.com/7.x/avataaars/svg?seed={{ header.avatar_seed }}"
              alt="{{ header.user_name }}"
              class="w-full h-full object-cover" />
          </div>
          <div>
            <div class="text-sm font-semibold">{{ header.user_name }}</div>
            <div class="text-xs text-muted-foreground">{{ header.egg_vision_count }} EggVision</div>
          </div>
        </div>

        <!-- Location/Device -->
        <div class="flex items-center gap-6 text-sm">
          <div class="flex items-center gap-2">
            <i data-lucide="zap" class="w-4 h-4 text-primary"></i>
            <span>{{ header.device }}</span>
          </div>
          <div class="flex items-center gap-2">
            <i data-lucide="map-pin" class="w-4 h-4 text-muted-foreground"></i>
            <span>{{ header.location }}</span>
          </div>
        </div>

        <!-- Date & Time -->
        <div class="flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2">
            <i data-lucide="calendar" class="w-4 h-4 text-muted-foreground"></i>
            <span id="live-date">{{ header.date_str }}</span>
          </div>
          <div class="flex items-center gap-2">
            <i data-lucide="clock" class="w-4 h-4 text-muted-foreground"></i>
            <span id="live-time">{{ header.time_str }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Top grid -->
    <div class="grid grid-cols-2 gap-6 mb-6">
      <!-- Left Column -->
      <div class="space-y-6">
        <!-- GradeChart -->
        <div class="bg-card rounded-lg p-6 border border-border">
          <div class="flex items-center gap-8">
            <!-- Donut -->
            <div class="relative w-48 h-48 flex items-center justify-center">
              <svg class="w-full h-full -rotate-90" viewBox="0 0 160 160">
                {% for g in grades %}
                  <circle cx="80" cy="80" r="{{ donut_r }}" fill="none"
                          stroke="{{ g.color }}" stroke-width="20"
                          stroke-dasharray="{{ '%.3f'|format(g.dash) }} {{ '%.3f'|format(g.gap) }}"
                          style="transform: rotate({{ '%.3f'|format(g.rotation) }}deg); transform-origin: 50% 50%;">
                  </circle>
                {% endfor %}
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-center">
                  <div class="text-3xl font-bold">{{ "{:,}".format(grades_total) }}</div>
                </div>
              </div>
            </div>

            <!-- Grade list -->
            <div class="flex-1 space-y-3">
              {% for g in grades %}
                <div class="flex items-center justify-between">
                  <span class="text-sm text-muted-foreground">{{ g.label }}</span>
                  <div class="flex items-center gap-2">
                    <span class="badge" style="background-color: {{ g.color }}20; color: {{ g.color }}">{{ g.count }}</span>
                    <span class="badge" style="background-color: {{ g.color }}20; color: {{ g.color }}">{{ g.percentage }}%</span>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- NotificationPanel -->
        <div class="space-y-2">
          <h3 class="text-lg font-semibold mb-4">Notifikasi</h3>
          {% for n in notifications %}
            <div class="flex items-center justify-between bg-card border border-info/30 border-l-4 border-l-info rounded-lg px-4 py-3">
              <span class="text-sm">{{ n.message }}</span>
              <button class="h-8 w-8 text-muted-foreground hover:text-foreground" aria-label="Close">
                <i data-lucide="x" class="w-4 h-4"></i>
              </button>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Right Column -->
      <div>
        <!-- EggDisplay -->
        <div class="bg-card rounded-lg p-6 border border-border">
          <div class="relative aspect-video bg-gradient-to-b from-background to-secondary rounded-lg overflow-hidden">
            <img src="{{ url_for('static', filename='img/egg-display.jpg') }}" alt="Egg Display" class="w-full h-full object-cover" />
            <!-- Controls bottom -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-4">
              <button class="ctrl-btn">
                <div class="flex items-center gap-1">
                  <span class="rec-dot"></span>
                  <span class="text-xs font-semibold">REC</span>
                </div>
              </button>
              <button class="ctrl-btn"><i data-lucide="camera" class="h-6 w-6"></i></button>
              <button class="ctrl-btn"><i data-lucide="chevron-left" class="h-6 w-6"></i></button>
            </div>
            <!-- Controls top-right -->
            <div class="absolute top-6 right-6 flex items-center gap-2">
              <button class="ctrl-btn-sm"><i data-lucide="focus" class="h-5 w-5"></i></button>
              <button class="ctrl-btn-sm"><i data-lucide="maximize-2" class="h-5 w-5"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Panel -->
   <div class="flex gap-6">
     <div class=" gap-6 mb-6" style="flex: 1;">
      <div class="space-y-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Status Alat</h3>
          <div class="flex items-center gap-4 text-sm">
            <div class="flex items-center gap-4 text-sm">
  <!-- Dropdown: List -->
  <div class="dropdown" data-dropdown>
    <button class="hover:text-primary flex items-center gap-2" data-dropdown-button>
      <span id="listLabel">List</span>
      <i data-lucide="chevron-down" class="h-4 w-4"></i>
    </button>
    <div class="dropdown-menu">
      <div class="px-3 py-2 text-xs text-muted-foreground">Filter daftar</div>
      <button class="dropdown-item" data-list-value="Semua">
        <i data-lucide="list" class="w-4 h-4"></i><span>Semua</span>
      </button>
      <button class="dropdown-item" data-list-value="Konveyor">
        <i data-lucide="settings-2" class="w-4 h-4"></i><span>Konveyor</span>
      </button>
      <button class="dropdown-item" data-list-value="Vision Camera">
        <i data-lucide="camera" class="w-4 h-4"></i><span>Vision Camera</span>
      </button>
      <button class="dropdown-item" data-list-value="Load Cell">
        <i data-lucide="scale" class="w-4 h-4"></i><span>Load Cell</span>
      </button>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" data-list-value="Hanya Aktif">
        <i data-lucide="check-circle-2" class="w-4 h-4"></i><span>Hanya Aktif</span>
      </button>
      <button class="dropdown-item" data-list-value="Hanya Nonaktif">
        <i data-lucide="circle-off" class="w-4 h-4"></i><span>Hanya Nonaktif</span>
      </button>
    </div>
  </div>

  <!-- Dropdown: All Cameras -->
  <div class="dropdown" data-dropdown>
    <button class="hover:text-primary flex items-center gap-2" data-dropdown-button>
      <span id="camLabel">All Cameras</span>
      <i data-lucide="chevron-down" class="h-4 w-4"></i>
    </button>
    <div class="dropdown-menu w-64">
      <div class="px-3 py-2 text-xs text-muted-foreground">Pilih kamera yang aktif</div>
      <label class="dropdown-item">
        <input type="checkbox" class="checkbox" data-cam="A1" checked>
        <span>Camera A1 (Jalur Kanan)</span>
      </label>
      <label class="dropdown-item">
        <input type="checkbox" class="checkbox" data-cam="A2" checked>
        <span>Camera A2 (Jalur Tengah)</span>
      </label>
      <label class="dropdown-item">
        <input type="checkbox" class="checkbox" data-cam="A3" checked>
        <span>Camera A3 (Jalur Kiri)</span>
      </label>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" id="camSelectAll">
        <i data-lucide="check-square" class="w-4 h-4"></i><span>Pilih semua</span>
      </button>
      <button class="dropdown-item" id="camSelectNone">
        <i data-lucide="square" class="w-4 h-4"></i><span>Kosongkan</span>
      </button>
    </div>
  </div>
</div>
          </div>
        </div>

        <div class="space-y-2">
          {% for item in status_items %}
            <div class="space-y-1">
              <div class="flex items-center justify-between bg-card border rounded-lg px-4 py-3
                {% if item.variant == 'danger' %} border-destructive/30 border-l-4 border-l-destructive
                {% elif item.variant == 'success' %} border-success/30 border-l-4 border-l-success
                {% else %} border-info/30 border-l-4 border-l-info {% endif %}">
                <span class="text-sm font-medium">{{ item.label }}</span>
                <div class="flex items-center gap-2">
                  <label class="switch">
                    <input type="checkbox" {% if item.is_on %}checked{% endif %} />
                    <span class="slider"></span>
                  </label>
                  <span class="text-xs font-semibold {{ 'text-success' if item.is_on else 'text-muted-foreground' }}">{{ 'On' if item.is_on else 'Off' }}</span>
                </div>
              </div>

              {% if item.sub_items %}
                <div class="ml-4 space-y-1">
                  {% for sub in item.sub_items %}
                    <div class="flex items-center justify-between rounded-lg px-4 py-2
                      {% if item.variant == 'danger' %} bg-destructive/10
                      {% elif item.variant == 'success' %} bg-success/10
                      {% else %} bg-info/10 {% endif %}">
                      <span class="text-xs">{{ sub.label }}</span>
                      <div class="flex items-center gap-2">
                        <label class="switch sm">
                          <input type="checkbox" {% if sub.is_on %}checked{% endif %} />
                          <span class="slider"></span>
                        </label>
                        <span class="text-xs font-semibold {{ 'text-success' if sub.is_on else 'text-muted-foreground' }}">{{ 'On' if sub.is_on else 'Off' }}</span>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- DataTable -->
    <div class="space-y-4" style="flex: 1;">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Real Time Data</h3>
        <div class="flex items-center gap-4 text-sm">
          <span class="text-muted-foreground">{{ table_meta.total_records }}</span>
          <span class="text-muted-foreground">No of row in table: {{ table_meta.rows_shown }}</span>
          <div class="dropdown" data-dropdown>
    <button class="hover:text-primary flex items-center gap-2" data-dropdown-button>
      <span id="camLabel">Sort By</span>
      <i data-lucide="chevron-down" class="h-4 w-4"></i>
    </button>
    <div class="dropdown-menu w-64">
      <div class="px-3 py-2 text-xs text-muted-foreground">Pilih kamera yang aktif</div>
      <label class="dropdown-item">
        <input type="checkbox" class="checkbox" data-cam="A1" checked>
        <span>Camera A1 (Jalur Kanan)</span>
      </label>
      <label class="dropdown-item">
        <input type="checkbox" class="checkbox" data-cam="A2" checked>
        <span>Camera A2 (Jalur Tengah)</span>
      </label>
      <label class="dropdown-item">
        <input type="checkbox" class="checkbox" data-cam="A3" checked>
        <span>Camera A3 (Jalur Kiri)</span>
      </label>
      <div class="dropdown-divider"></div>
      <button class="dropdown-item" id="camSelectAll">
        <i data-lucide="check-square" class="w-4 h-4"></i><span>Pilih semua</span>
      </button>
      <button class="dropdown-item" id="camSelectNone">
        <i data-lucide="square" class="w-4 h-4"></i><span>Kosongkan</span>
      </button>
    </div>
  </div>
        </div>
      </div>

      <div class="border border-border rounded-lg overflow-hidden">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-secondary border-b border-border">
              <th class="th">No.</th>
              <th class="th">ID Numerik</th>
              <th class="th">Tanggal</th>
              <th class="th">Ketebalan</th>
              <th class="th">Kebersihan</th>
              <th class="th">Keutuhan</th>
              <th class="th">Kesegaran</th>
              <th class="th">Berat Telur</th>
            </tr>
          </thead>
          <tbody>
            {% for r in records %}
              <tr class="border-b border-border hover:bg-secondary/50">
                <td class="td">{{ r.no }}</td>
                <td class="td">{{ r.idNumerik }}</td>
                <td class="td">{{ r.tanggal }}</td>
                <td class="td">{{ r.ketebalan }}</td>
                <td class="td">{{ r.kebersihan }}</td>
                <td class="td">{{ r.keutuhan }}</td>
                <td class="td">{{ r.kesegaran }}</td>
                <td class="td">{{ r.beratTelur }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
   </div>

  </main>
</div>
{% endblock %}



{% block scripts %}
<script>
(function(){
  // open/close
  const closeAll = () => document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
  document.querySelectorAll('[data-dropdown]').forEach(d => {
    d.querySelector('[data-dropdown-button]').addEventListener('click', (e) => {
      e.stopPropagation();
      document.querySelectorAll('.dropdown.open').forEach(o => { if(o!==d) o.classList.remove('open'); });
      d.classList.toggle('open');
    });
  });
  document.addEventListener('click', closeAll);
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeAll(); });

  // List selection
  const listLabel = document.getElementById('listLabel');
  document.querySelectorAll('[data-list-value]').forEach(btn => {
    btn.addEventListener('click', () => {
      const val = btn.getAttribute('data-list-value');
      listLabel.textContent = val;
      window.dispatchEvent(new CustomEvent('status:list-change', { detail: { value: val }}));
      closeAll();
    });
  });

  // Cameras selection
  const camLabel = document.getElementById('camLabel');
  function updateCamLabel() {
    const boxes = document.querySelectorAll('.dropdown-menu input[type="checkbox"][data-cam]');
    const selected = Array.from(boxes).filter(b => b.checked).map(b => b.getAttribute('data-cam'));
    camLabel.textContent = (selected.length === boxes.length) ? 'All Cameras' : `${selected.length} selected`;
    window.dispatchEvent(new CustomEvent('status:cameras-change', { detail: { cameras: selected }}));
  }
  document.querySelectorAll('.dropdown-menu input[type="checkbox"][data-cam]').forEach(b => {
    b.addEventListener('change', updateCamLabel);
  });
  document.getElementById('camSelectAll')?.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-menu input[type="checkbox"][data-cam]').forEach(b => b.checked = true);
    updateCamLabel(); closeAll();
  });
  document.getElementById('camSelectNone')?.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-menu input[type="checkbox"][data-cam]').forEach(b => b.checked = false);
    updateCamLabel(); closeAll();
  });
  updateCamLabel();
})();
</script>
{% endblock %}
